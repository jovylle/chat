<!DOCTYPE html>
<html id="thehtml">

<head>
  <title>QuickGPT - AI Chat Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="QuickGPT - Fast, modern AI chat interface with markdown support and beautiful dark theme">
  <meta name="keywords" content="AI, ChatGPT, chat, assistant, GPT-3.5, markdown">
  <meta name="author" content="jovyllebermudez">
  
  <!-- Performance optimizations -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="preload" href="prism.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="prism.css"></noscript>
  
  <!-- Lazy load marked.js - will be loaded when first message is sent -->
  <script>
    // Lazy load marked.js when needed
    let markedLoaded = false;
    function loadMarked() {
      if (markedLoaded) return Promise.resolve();
      return new Promise((resolve) => {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
        script.onload = () => {
          markedLoaded = true;
          marked.setOptions({
            breaks: true,
            gfm: true,
            sanitize: false
          });
          resolve();
        };
        document.head.appendChild(script);
      });
    }
  </script>
  <style>
    :root {
      --bg-primary: #0f0f0f;
      --bg-secondary: #1a1a1a;
      --bg-tertiary: #2d2d2d;
      --bg-message-user: #3b82f6;
      --bg-message-ai: #2d2d2d;
      --text-primary: #ffffff;
      --text-secondary: #a0a0a0;
      --text-muted: #666666;
      --border-color: #404040;
      --accent-color: #3b82f6;
      --accent-hover: #2563eb;
      --success-color: #10b981;
      --error-color: #ef4444;
      --shadow-light: 0 1px 3px rgba(0, 0, 0, 0.3);
      --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.4);
      --shadow-heavy: 0 8px 25px rgba(0, 0, 0, 0.5);
    }

    html[data-theme="light"] {
      --bg-primary: #f5f5f5;
      --bg-secondary: #ffffff;
      --bg-tertiary: #e5e5e5;
      --bg-message-ai: #f0f0f0;
      --text-primary: #171717;
      --text-secondary: #525252;
      --text-muted: #737373;
      --border-color: #d4d4d4;
      --shadow-light: 0 1px 3px rgba(0, 0, 0, 0.08);
      --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.1);
      --shadow-heavy: 0 8px 25px rgba(0, 0, 0, 0.12);
    }

    html[data-theme="light"] body {
      background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 50%, #d4d4d4 100%);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: linear-gradient(135deg, var(--bg-primary) 0%, #1a1a2e 50%, #16213e 100%);
      color: var(--text-primary);
      overflow-x: hidden;
    }

    .chat-container {
      min-height: 100vh;
      background: var(--bg-secondary);
      box-shadow: var(--shadow-heavy);
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .chat-header {
      background: linear-gradient(90deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
      color: var(--text-primary);
      padding: 20px;
      text-align: center;
      font-size: 24px;
      font-weight: 600;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      backdrop-filter: blur(10px);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .export-chat-btn {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .export-chat-btn:hover {
      background: var(--accent-color);
      color: white;
      transform: translateY(-1px);
      box-shadow: var(--shadow-light);
    }

    .clear-chat-btn {
      background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .clear-chat-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-medium);
    }

    .chat-wrapper {
      display: flex;
      flex-grow: 1;
      padding: 20px;
      overflow-y: auto;
      background: var(--bg-secondary);
      font-size: 16px;
      justify-content: center;
    }

    .chat-messages {
      flex-grow: 1;
      max-width: 800px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .message {
      padding: 16px 20px;
      border-radius: 16px;
      max-width: 85%;
      word-wrap: break-word;
      animation: messageSlideIn 0.3s ease-out;
      position: relative;
    }

    @keyframes messageSlideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .user-message {
      background: linear-gradient(135deg, var(--bg-message-user), #2563eb);
      color: white;
      align-self: flex-end;
      text-align: right;
      box-shadow: var(--shadow-light);
    }

    .user-message-inner {
      display: flex;
      align-items: flex-start;
      justify-content: flex-end;
      gap: 8px;
    }

    .user-message-text { flex: 1; word-break: break-word; }
    .user-message-actions { display: flex; gap: 4px; flex-shrink: 0; }

    .message-delete {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
      opacity: 0.7;
    }

    .message-delete:hover { opacity: 1; background: rgba(255,255,255,0.3); }
    .ai-message .message-delete { background: var(--bg-tertiary); color: var(--text-secondary); }
    .ai-message .message-delete:hover { background: var(--error-color); color: white; }

    .scroll-to-bottom-btn {
      position: fixed;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%);
      margin: 0;
      background: var(--accent-color);
      color: white;
      border: none;
      border-radius: 24px;
      padding: 10px 20px;
      font-size: 14px;
      cursor: pointer;
      box-shadow: var(--shadow-medium);
      z-index: 100;
      opacity: 0.95;
      transition: opacity 0.2s;
      display: none;
    }

    .scroll-to-bottom-btn:hover { opacity: 1; }
    .scroll-to-bottom-btn.visible { display: block; animation: messageSlideIn 0.2s ease-out; }

    .export-dropdown {
      position: relative;
    }

    .export-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: var(--shadow-medium);
      z-index: 200;
      min-width: 140px;
      padding: 4px;
      display: none;
    }

    .export-menu.visible { display: block; }
    .export-menu button {
      display: block;
      width: 100%;
      padding: 8px 12px;
      text-align: left;
      background: none;
      border: none;
      color: var(--text-primary);
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
    }
    .export-menu button:hover { background: var(--accent-color); color: white; }

    .toast-with-action { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .toast-with-action .toast-retry { background: rgba(255,255,255,0.3); border: none; color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; }
    .toast-with-action .toast-retry:hover { background: rgba(255,255,255,0.5); }

    .ai-message {
      background: var(--bg-message-ai);
      color: var(--text-primary);
      text-align: left;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-light);
    }

    .ai-message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .ai-label {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .copy-btn {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      opacity: 0.7;
    }

    .copy-btn:hover {
      opacity: 1;
      background: var(--accent-color);
      color: white;
      transform: scale(1.05);
    }

    .regenerate-btn {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      opacity: 0.7;
    }

    .regenerate-btn:hover {
      opacity: 1;
      background: var(--accent-color);
      color: white;
    }

    .stop-btn {
      padding: 16px 24px;
      background: var(--error-color);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      min-width: 80px;
      transition: all 0.2s ease;
    }

    .stop-btn:hover {
      filter: brightness(1.1);
    }

    .theme-toggle {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .theme-toggle:hover {
      background: var(--accent-color);
      color: white;
    }

    .input-container {
      display: flex;
      align-items: center;
      padding: 20px;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-color);
      justify-content: center;
      gap: 12px;
    }

    .input-wrapper {
      position: relative;
      flex-grow: 1;
      max-width: 600px;
    }

    #user-input {
      flex-grow: 1;
      width: 100%;
      min-height: 52px;
      max-height: 200px;
      padding: 16px 20px;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      font-size: 16px;
      font-family: inherit;
      max-width: 600px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      transition: all 0.3s ease;
      resize: vertical;
    }

    #user-input:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    #user-input::placeholder {
      color: var(--text-muted);
    }

    .char-counter {
      position: absolute;
      bottom: -20px;
      right: 0;
      font-size: 12px;
      color: var(--text-muted);
      opacity: 0.7;
    }

    .char-counter.warning {
      color: #f59e0b;
    }

    .char-counter.danger {
      color: #ef4444;
    }

    #send-button {
      padding: 16px 24px;
      background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
      min-width: 80px;
    }

    #send-button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: var(--shadow-medium);
    }

    #send-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    #send-button .btn-spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid rgba(255,255,255,0.4);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
    }

    .suggested-prompts {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 16px;
      padding: 0 20px;
    }

    .suggested-prompt {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 10px 18px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .suggested-prompt:hover {
      background: var(--accent-color);
      color: white;
      border-color: var(--accent-color);
      transform: translateY(-2px);
      box-shadow: var(--shadow-light);
    }

    .placeholder-message {
      color: var(--text-muted);
      margin: auto;
      text-align: center;
      font-size: 18px;
      opacity: 0.8;
    }

    .loading-yet {
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background: var(--accent-color);
      border-radius: 50%;
      animation: typingBounce 1.4s ease-in-out infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typingBounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-6px); }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .info-button {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      height: 24px;
      width: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .info-button:hover {
      background: var(--accent-color);
      color: white;
      transform: scale(1.1);
    }

    .info-panel {
      position: absolute;
      top: 60px;
      right: 20px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      padding: 16px;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      box-shadow: var(--shadow-medium);
      z-index: 1000;
      min-width: 250px;
      display: none;
    }

    .info-panel a {
      color: var(--accent-color);
      text-decoration: none;
    }

    .info-panel a:hover {
      text-decoration: underline;
    }

    .info-button:hover + .info-panel,
    .info-panel:hover {
      display: block;
    }

    /* Markdown styling */
    .ai-message h1, .ai-message h2, .ai-message h3, .ai-message h4, .ai-message h5, .ai-message h6 {
      color: var(--text-primary);
      margin: 16px 0 8px 0;
    }

    .ai-message h1 { font-size: 24px; }
    .ai-message h2 { font-size: 20px; }
    .ai-message h3 { font-size: 18px; }

    .ai-message p {
      margin: 8px 0;
      line-height: 1.6;
    }

    .ai-message ul, .ai-message ol {
      margin: 8px 0;
      padding-left: 24px;
    }

    .ai-message li {
      margin: 4px 0;
    }

    .ai-message code {
      background: var(--bg-primary);
      color: #f8f8f2;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 14px;
    }

    .ai-message pre {
      background: var(--bg-primary);
      color: #f8f8f2;
      padding: 16px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 12px 0;
      border: 1px solid var(--border-color);
    }

    .ai-message pre code {
      background: none;
      padding: 0;
    }

    .ai-message blockquote {
      border-left: 4px solid var(--accent-color);
      margin: 12px 0;
      padding-left: 16px;
      color: var(--text-secondary);
      font-style: italic;
    }

    .ai-message strong {
      color: var(--text-primary);
      font-weight: 600;
    }

    .ai-message em {
      color: var(--text-secondary);
    }

    /* Toast notification */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: var(--shadow-medium);
      z-index: 10000;
      animation: toastSlideIn 0.3s ease-out;
    }

    .toast.toast-success,
    .toast { background: var(--success-color); }
    .toast.toast-error { background: var(--error-color); }

    @keyframes toastSlideIn {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .chat-header {
        padding: 15px;
        font-size: 20px;
      }
      
      .chat-wrapper {
        padding: 15px;
      }
      
      .message {
        max-width: 95%;
        padding: 12px 16px;
      }
      
      .input-container {
        padding: 15px;
        gap: 8px;
      }
      
      #user-input {
        font-size: 16px;
        padding: 12px 16px;
        min-height: 44px;
      }
      
      #send-button {
        padding: 12px 20px;
        font-size: 14px;
      }
    }
  </style>
</head>

<body>
  <div class="chat-container">
    <div class="chat-header">
      <div class="header-left">
        <span>Ask Right Away!</span>
        <div class="info-button">i</div>
        <div class="info-panel">
          <p>ChatGPT of OpenAI Model 3.5</p>
          <p>github link:<a href="https://github.com/jovyllebermudez/quick-chatgpt">quick-chatgpt</a></p>
        </div>
      </div>
      <div class="header-actions">
        <button class="theme-toggle" id="theme-toggle" title="Toggle light/dark" aria-label="Toggle theme">üåô</button>
        <div class="export-dropdown">
          <button class="export-chat-btn" id="export-chat-btn" title="Export Chat" aria-label="Export chat" aria-haspopup="true" aria-expanded="false">
            <span>üì•</span>
          </button>
          <div class="export-menu" id="export-menu" role="menu">
            <button type="button" role="menuitem" data-format="json">JSON</button>
            <button type="button" role="menuitem" data-format="txt">TXT</button>
            <button type="button" role="menuitem" data-format="md">Markdown</button>
            <button type="button" role="menuitem" data-format="all">All formats</button>
          </div>
        </div>
        <button class="clear-chat-btn" id="clear-chat-btn" aria-label="Start new chat">
          <span>üóëÔ∏è</span>
          <span>New Chat</span>
        </button>
      </div>
    </div>
    <div class="chat-wrapper" id="chat-wrapper">
      <button type="button" class="scroll-to-bottom-btn" id="scroll-to-bottom-btn" aria-label="Scroll to bottom">‚Üì New messages</button>
      <div class="chat-messages" id="chat-box" role="log" aria-live="polite" aria-label="Chat messages">
        <div class="placeholder-message" id="placeholder-wrap">
          <span>Start a conversation by typing a message...</span>
          <div class="suggested-prompts" id="suggested-prompts">
            <button type="button" class="suggested-prompt" data-prompt="Explain quantum computing in simple terms">Explain quantum computing</button>
            <button type="button" class="suggested-prompt" data-prompt="Write a short haiku about coding">Write a haiku</button>
            <button type="button" class="suggested-prompt" data-prompt="Help me debug: my function returns undefined">Debug this code</button>
            <button type="button" class="suggested-prompt" data-prompt="Summarize the key points of a long article">Summarize an article</button>
          </div>
        </div>
      </div>
    </div>
    <div class="input-container">
      <div class="input-wrapper">
        <textarea id="user-input" placeholder="Type your message... (Enter to send, Shift+Enter for new line)" autofocus aria-label="Message input" maxlength="2000" rows="1"></textarea>
        <div class="char-counter" id="char-counter">0 / 2000</div>
      </div>
      <button id="send-button" type="button" aria-label="Send message">Send</button>
      <button id="stop-button" type="button" class="stop-btn" aria-label="Stop generation" style="display: none;">Stop</button>
    </div>
  </div>
  <script>
    const STORAGE_KEY = 'quickgpt_history';
    const THEME_KEY = 'quickgpt_theme';
    const MAX_CHARS = 2000;
    const messageHistory = [];
    let currentAbortController = null;
    let lastFailedUserMessage = null;

    const userInput = document.getElementById('user-input');
    const chatBox = document.getElementById('chat-box');
    const chatWrapper = document.getElementById('chat-wrapper');
    const sendButton = document.getElementById('send-button');
    const stopButton = document.getElementById('stop-button');
    const clearChatBtn = document.getElementById('clear-chat-btn');
    const exportChatBtn = document.getElementById('export-chat-btn');
    const exportMenu = document.getElementById('export-menu');
    const scrollToBottomBtn = document.getElementById('scroll-to-bottom-btn');
    const themeToggle = document.getElementById('theme-toggle');
    const charCounter = document.getElementById('char-counter');

    function getPlaceholder() {
      return document.getElementById('placeholder-wrap') || document.querySelector('.placeholder-message');
    }

    function setSendLoading(loading) {
      sendButton.disabled = loading;
      sendButton.style.opacity = loading ? 0.6 : 1;
      sendButton.style.display = loading ? 'none' : '';
      stopButton.style.display = loading ? '' : 'none';
      if (loading) {
        sendButton.setAttribute('aria-busy', 'true');
      } else {
        sendButton.innerHTML = 'Send';
        sendButton.removeAttribute('aria-busy');
      }
    }

    function doFetch(userMessage, loadingMessageId) {
      currentAbortController = new AbortController();
      fetch('/.netlify/functions/chat', {
        method: 'POST',
        body: JSON.stringify({ message: userMessage, history: messageHistory }),
        headers: { 'Content-Type': 'application/json' },
        signal: currentAbortController.signal
      })
        .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, data })))
        .then(async ({ ok, status, data }) => {
          const errorMsg = data.error || (ok ? null : 'Request failed');
          const aiMessage = ok ? data.message : ('**Error:** ' + (errorMsg || 'Please try again.'));
          await replaceLoadingMessage(loadingMessageId, aiMessage);
          if (ok) {
            messageHistory.push({ role: 'user', content: userMessage });
            messageHistory.push({ role: 'assistant', content: data.message });
            saveHistory();
            lastFailedUserMessage = null;
          } else {
            if (status === 429) lastFailedUserMessage = userMessage;
            showToast(errorMsg || 'Something went wrong.', 'error', status === 429 ? userMessage : null);
          }
          setSendLoading(false);
          updateCharCounter();
          scrollToBottom();
        })
        .catch(error => {
          if (error.name === 'AbortError') {
            replaceLoadingMessage(loadingMessageId, '*Generation stopped.*');
          } else {
            console.error('An error occurred:', error);
            replaceLoadingMessage(loadingMessageId, 'Sorry, having trouble connecting. Please check your connection and try again.');
            showToast('Connection error. Please try again.', 'error');
          }
          setSendLoading(false);
          updateCharCounter();
          scrollToBottom();
        });
    }

    function stopRequest() {
      if (currentAbortController) currentAbortController.abort();
    }

    function sendMessageHandler() {
      const placeholderEl = getPlaceholder();
      if (placeholderEl) placeholderEl.style.display = 'none';

      const userMessage = userInput.value.trim();
      if (!userMessage) return;
      if (userMessage.length > MAX_CHARS) {
        showToast('Message is too long. Max ' + MAX_CHARS + ' characters.', 'error');
        return;
      }

      addUserMessage(userMessage);
      const loadingMessageId = addLoadingMessage();
      userInput.value = '';
      updateCharCounter();
      setSendLoading(true);
      doFetch(userMessage, loadingMessageId);
    }

    function addUserMessage(message) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message user-message';
      messageDiv.innerHTML = `
        <div class="user-message-inner">
          <span class="user-message-text">${escapeHtml(message)}</span>
          <span class="user-message-actions">
            <button type="button" class="copy-btn message-delete" onclick="copyUserMessage(this)" title="Copy">üìã</button>
            <button type="button" class="message-delete" onclick="deleteMessage(this)" title="Delete">üóëÔ∏è</button>
          </span>
        </div>
      `;
      chatBox.appendChild(messageDiv);
      scrollToBottom();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function addLoadingMessage() {
      const messageId = 'loading-' + Date.now();
      const messageDiv = document.createElement('div');
      messageDiv.id = messageId;
      messageDiv.className = 'message ai-message loading-yet';
      messageDiv.innerHTML = '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
      chatBox.appendChild(messageDiv);
      scrollToBottom();
      return messageId;
    }

    function deleteMessage(button) {
      const msgEl = button.closest('.message');
      if (!msgEl) return;
      const messages = Array.from(chatBox.querySelectorAll('.message'));
      const idx = messages.indexOf(msgEl);
      if (idx < 0) return;
      const isUser = msgEl.classList.contains('user-message');
      let otherEl = null;
      if (isUser && messages[idx + 1] && messages[idx + 1].classList.contains('ai-message')) {
        otherEl = messages[idx + 1];
      } else if (!isUser && messages[idx - 1] && messages[idx - 1].classList.contains('user-message')) {
        otherEl = messages[idx - 1];
      }
      const pairIndex = isUser ? Math.floor(idx / 2) : Math.floor((idx - 1) / 2);
      messageHistory.splice(pairIndex * 2, 2);
      msgEl.remove();
      if (otherEl) otherEl.remove();
      saveHistory();
      if (messageHistory.length === 0) renderPlaceholder();
      updateScrollToBottomVisibility();
    }

    async function replaceLoadingMessage(messageId, content, showRegenerate = true) {
      const loadingElement = document.getElementById(messageId);
      if (!loadingElement) return;
      loadingElement.classList.remove('loading-yet');

      const aiMessageContent = document.createElement('div');
      aiMessageContent.className = 'ai-message-content';
      const header = document.createElement('div');
      header.className = 'ai-message-header';
      const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const copyBtn = '<button class="copy-btn" type="button" onclick="copyMessage(this)">üìã Copy</button>';
      const regenBtn = showRegenerate ? '<button class="regenerate-btn" type="button" onclick="regenerateResponse(this)">üîÑ Regenerate</button>' : '';
      const delBtn = '<button type="button" class="message-delete" onclick="deleteMessage(this)" title="Delete">üóëÔ∏è</button>';
      header.innerHTML = `
        <span class="ai-label">AI Assistant ‚Ä¢ ${timestamp}</span>
        <span>${regenBtn} ${copyBtn} ${delBtn}</span>
      `;
      const contentDiv = document.createElement('div');
      await loadMarked();
      contentDiv.innerHTML = marked.parse(content);
      aiMessageContent.appendChild(header);
      aiMessageContent.appendChild(contentDiv);
      loadingElement.appendChild(aiMessageContent);

      if (typeof Prism !== 'undefined') {
        contentDiv.querySelectorAll('pre code').forEach(el => Prism.highlightElement(el));
      }
      scrollToBottom();
    }

    function regenerateResponse(button) {
      const aiMsgEl = button.closest('.ai-message');
      if (!aiMsgEl) return;
      const messages = Array.from(chatBox.querySelectorAll('.message'));
      const idx = messages.indexOf(aiMsgEl);
      if (idx < 1) return;
      const userMsgEl = messages[idx - 1];
      const textEl = userMsgEl.querySelector('.user-message-text');
      const userContent = (textEl ? textEl.textContent : userMsgEl.textContent).trim();
      const pairIndex = Math.floor((idx - 1) / 2);
      messageHistory.splice(pairIndex * 2, 2);
      userMsgEl.remove();
      aiMsgEl.remove();
      if (messageHistory.length === 0) renderPlaceholder();
      addUserMessage(userContent);
      const loadingMessageId = addLoadingMessage();
      setSendLoading(true);
      doFetch(userContent, loadingMessageId);
    }

    function copyMessage(button) {
      const messageContent = button.closest('.ai-message').querySelector('.ai-message-content > div:last-child');
      const textToCopy = messageContent ? (messageContent.textContent || messageContent.innerText) : '';
      copyToClipboard(textToCopy, button, 'üìã Copy');
    }

    function copyUserMessage(button) {
      const wrap = button.closest('.user-message');
      const textEl = wrap ? wrap.querySelector('.user-message-text') : null;
      const textToCopy = textEl ? textEl.textContent : '';
      copyToClipboard(textToCopy, button, 'üìã');
    }

    function copyToClipboard(text, button, resetLabel) {
      navigator.clipboard.writeText(text).then(() => {
        showToast('Message copied to clipboard!');
        button.textContent = '‚úÖ';
        button.style.background = 'var(--success-color)';
        setTimeout(() => { button.textContent = resetLabel; button.style.background = ''; }, 2000);
      }).catch(() => showToast('Failed to copy message', 'error'));
    }

    function showToast(message, type = 'success', retryUserMessage = null) {
      const toast = document.createElement('div');
      toast.className = 'toast toast-' + type + (retryUserMessage ? ' toast-with-action' : '');
      toast.setAttribute('role', 'status');
      toast.appendChild(document.createTextNode(message));
      if (retryUserMessage) {
        const retryBtn = document.createElement('button');
        retryBtn.type = 'button';
        retryBtn.className = 'toast-retry';
        retryBtn.textContent = 'Retry';
        retryBtn.addEventListener('click', () => {
          toast.remove();
          if (lastFailedUserMessage) {
            addUserMessage(lastFailedUserMessage);
            const loadingMessageId = addLoadingMessage();
            setSendLoading(true);
            doFetch(lastFailedUserMessage, loadingMessageId);
          }
        });
        toast.appendChild(retryBtn);
      }
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), retryUserMessage ? 8000 : 3000);
    }

    function downloadExport(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportChat(format) {
      if (messageHistory.length === 0) {
        showToast('No messages to export', 'error');
        return;
      }
      const dateStr = new Date().toISOString().split('T')[0];
      const exportData = {
        timestamp: new Date().toISOString(),
        messages: messageHistory,
        totalMessages: messageHistory.length
      };
      const jsonData = JSON.stringify(exportData, null, 2);
      const textData = messageHistory.map(m => (m.role === 'user' ? 'You' : 'AI') + ': ' + m.content).join('\n\n');
      const mdData = messageHistory.map(m => (m.role === 'user' ? '**You:**' : '**AI:**') + '\n\n' + m.content).join('\n\n---\n\n');

      if (format === 'json' || format === 'all') downloadExport(new Blob([jsonData], { type: 'application/json' }), 'quickgpt-chat-' + dateStr + '.json');
      if (format === 'txt' || format === 'all') downloadExport(new Blob([textData], { type: 'text/plain' }), 'quickgpt-chat-' + dateStr + '.txt');
      if (format === 'md' || format === 'all') downloadExport(new Blob([mdData], { type: 'text/markdown' }), 'quickgpt-chat-' + dateStr + '.md');
      showToast(format === 'all' ? 'Chat exported (JSON, TXT, Markdown)!' : 'Exported as ' + format.toUpperCase() + '!');
    }

    function updateCharCounter() {
      const length = userInput.value.length;
      charCounter.textContent = length + ' / ' + MAX_CHARS;
      charCounter.classList.toggle('warning', length > MAX_CHARS * 0.8);
      charCounter.classList.toggle('danger', length > MAX_CHARS * 0.95);
      sendButton.disabled = sendButton.getAttribute('aria-busy') === 'true' || length > MAX_CHARS;
    }

    function renderPlaceholder() {
      const wrap = document.createElement('div');
      wrap.className = 'placeholder-message';
      wrap.id = 'placeholder-wrap';
      wrap.innerHTML = '<span>Start a conversation by typing a message...</span>' +
        '<div class="suggested-prompts" id="suggested-prompts">' +
        '<button type="button" class="suggested-prompt" data-prompt="Explain quantum computing in simple terms">Explain quantum computing</button>' +
        '<button type="button" class="suggested-prompt" data-prompt="Write a short haiku about coding">Write a haiku</button>' +
        '<button type="button" class="suggested-prompt" data-prompt="Help me debug: my function returns undefined">Debug this code</button>' +
        '<button type="button" class="suggested-prompt" data-prompt="Summarize the key points of a long article">Summarize an article</button>' +
        '</div>';
      chatBox.appendChild(wrap);
      wrap.querySelectorAll('.suggested-prompt').forEach(btn => {
        btn.addEventListener('click', () => {
          userInput.value = btn.dataset.prompt || '';
          userInput.focus();
          updateCharCounter();
          sendMessageHandler();
        });
      });
    }

    function clearChat() {
      messageHistory.length = 0;
      saveHistory();
      chatBox.innerHTML = '';
      renderPlaceholder();
      userInput.value = '';
      userInput.focus();
      updateCharCounter();
      chatBox.scrollTop = 0;
    }

    function scrollToBottom() {
      const wrapper = document.getElementById('chat-wrapper');
      if (wrapper) wrapper.scrollTo({ top: wrapper.scrollHeight, behavior: 'smooth' });
      updateScrollToBottomVisibility();
    }

    function updateScrollToBottomVisibility() {
      const wrapper = document.getElementById('chat-wrapper');
      if (!wrapper || !scrollToBottomBtn) return;
      const threshold = 100;
      const nearBottom = wrapper.scrollHeight - wrapper.scrollTop - wrapper.clientHeight < threshold;
      scrollToBottomBtn.classList.toggle('visible', !nearBottom && messageHistory.length > 0);
    }

    function saveHistory() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(messageHistory));
      } catch (e) { /* ignore */ }
    }

    async function loadHistory() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr) || arr.length === 0) return;
        messageHistory.length = 0;
        messageHistory.push(...arr);
        const ph = getPlaceholder();
        if (ph) ph.remove();
        for (const m of messageHistory) {
          if (m.role === 'user') addUserMessage(m.content);
          else {
            const id = addLoadingMessage();
            await replaceLoadingMessage(id, m.content);
          }
        }
        scrollToBottom();
      } catch (e) { /* ignore */ }
    }

    function applyTheme(theme) {
      const t = theme || 'dark';
      if (t === 'light') document.documentElement.setAttribute('data-theme', 'light');
      else document.documentElement.removeAttribute('data-theme');
      try { localStorage.setItem(THEME_KEY, t); } catch (e) {}
      themeToggle.textContent = (t === 'light') ? '‚òÄÔ∏è' : 'üåô';
      themeToggle.setAttribute('aria-label', (t === 'light') ? 'Switch to dark mode' : 'Switch to light mode');
    }

    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme');
      applyTheme(current === 'light' ? 'dark' : 'light');
    }

    sendButton.addEventListener('click', sendMessageHandler);
    stopButton.addEventListener('click', stopRequest);
    clearChatBtn.addEventListener('click', clearChat);
    themeToggle.addEventListener('click', toggleTheme);

    exportChatBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      exportMenu.classList.toggle('visible');
      exportChatBtn.setAttribute('aria-expanded', exportMenu.classList.contains('visible'));
    });
    exportMenu.addEventListener('click', (e) => e.stopPropagation());
    exportMenu.querySelectorAll('[data-format]').forEach(btn => {
      btn.addEventListener('click', () => {
        exportChat(btn.dataset.format);
        exportMenu.classList.remove('visible');
        exportChatBtn.setAttribute('aria-expanded', 'false');
      });
    });
    document.addEventListener('click', () => {
      exportMenu.classList.remove('visible');
      exportChatBtn.setAttribute('aria-expanded', 'false');
    });

    chatWrapper.addEventListener('scroll', updateScrollToBottomVisibility);
    scrollToBottomBtn.addEventListener('click', () => { scrollToBottom(); scrollToBottomBtn.classList.remove('visible'); });

    userInput.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (sendButton.getAttribute('aria-busy') !== 'true' && userInput.value.length <= MAX_CHARS) sendMessageHandler();
      }
      if (e.key === 'Escape') {
        userInput.value = '';
        updateCharCounter();
        userInput.blur();
      }
    });
    userInput.addEventListener('input', function () {
      updateCharCounter();
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 200) + 'px';
    });

    document.addEventListener('keydown', function (e) {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        clearChat();
      }
    });

    document.getElementById('suggested-prompts').addEventListener('click', function (e) {
      const btn = e.target.closest('.suggested-prompt');
      if (!btn) return;
      userInput.value = btn.dataset.prompt || '';
      userInput.focus();
      updateCharCounter();
      sendMessageHandler();
    });

    userInput.focus();
    updateCharCounter();
    applyTheme(localStorage.getItem(THEME_KEY) || 'dark');
    loadHistory();
    updateScrollToBottomVisibility();
  </script>
  <script src="prism.js"></script>
</body>

</html>